name: Deploy Supabase Panel to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  VPS_HOST: '82.25.69.57'
  VPS_USER: 'root'
  APP_DIR: '/opt/supabase-panel'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ env.VPS_HOST }}
        username: ${{ env.VPS_USER }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        timeout: 600s
        command_timeout: 600s
        script: |
          set -e  # Parar script se houver erro
          
          # FunÃ§Ã£o de log
          log() {
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
          }
          
          # FunÃ§Ã£o para aguardar serviÃ§o
          wait_for_service() {
            local service=$1
            local max_wait=${2:-30}
            local count=0
            
            log "â³ Aguardando $service iniciar..."
            while [ $count -lt $max_wait ]; do
              if systemctl is-active --quiet $service 2>/dev/null; then
                log "âœ… $service ativo"
                return 0
              fi
              sleep 2
              count=$((count + 1))
            done
            log "âŒ $service nÃ£o iniciou apÃ³s ${max_wait}s"
            return 1
          }
          
          # ====================================
          # ETAPA 1: PREPARAR AMBIENTE
          # ====================================
          log "ğŸš€ INICIANDO DEPLOY SUPABASE PANEL - ETAPA 1: Preparando ambiente..."
          
          # ConfiguraÃ§Ãµes
          APP_DIR="${{ env.APP_DIR }}"
          REPO_URL="https://github.com/${{ github.repository }}.git"
          VPS_IP="${{ env.VPS_HOST }}"
          
          # Parar serviÃ§os existentes de forma segura
          log "â¹ï¸ Parando serviÃ§os existentes..."
          
          # Parar PM2 primeiro
          pm2 delete all 2>/dev/null || true
          pm2 kill 2>/dev/null || true
          
          # Parar Nginx temporariamente
          systemctl stop nginx 2>/dev/null || true
          
          # Parar containers Docker
          docker stop $(docker ps -aq) 2>/dev/null || true
          docker rm $(docker ps -aq) 2>/dev/null || true
          
          # Limpar processos Node.js Ã³rfÃ£os
          pkill -f "node.*server.js" 2>/dev/null || true
          pkill -f "npm.*start" 2>/dev/null || true
          
          # Criar e limpar diretÃ³rio
          mkdir -p $APP_DIR
          cd $APP_DIR
          rm -rf * .git .env 2>/dev/null || true
          
          # ====================================
          # ETAPA 2: BAIXAR CÃ“DIGO
          # ====================================
          log "ğŸš€ ETAPA 2: Baixando cÃ³digo..."
          
          # Tentar git clone primeiro
          if git clone $REPO_URL . 2>/dev/null; then
            log "âœ… RepositÃ³rio clonado via git"
          else
            log "ğŸ“¥ Usando download direto..."
            curl -L "https://github.com/${{ github.repository }}/archive/main.tar.gz" | tar xz --strip-components=1
          fi
          
          # Verificar estrutura
          if [ ! -f "panel/backend/server.js" ] || [ ! -f "panel/frontend/package.json" ]; then
            log "âŒ Estrutura incorreta. Arquivos encontrados:"
            find . -name "*.js" -o -name "*.json" | head -10
            exit 1
          fi
          log "âœ… CÃ³digo verificado"
          
          # ====================================
          # ETAPA 3: INSTALAR DEPENDÃŠNCIAS
          # ====================================
          log "ğŸš€ ETAPA 3: Instalando dependÃªncias..."
          
          # Atualizar sistema sem perguntas
          export DEBIAN_FRONTEND=noninteractive
          apt-get update -qq
          apt-get install -y curl wget gnupg lsb-release
          
          # Node.js 18 LTS
          if ! node --version 2>/dev/null | grep -q "v18"; then
            log "ğŸ“¦ Instalando Node.js 18..."
            curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
            apt-get install -y nodejs
            log "âœ… Node.js instalado: $(node --version)"
          else
            log "âœ… Node.js OK: $(node --version)"
          fi
          
          # Docker
          if ! command -v docker >/dev/null 2>&1; then
            log "ğŸ“¦ Instalando Docker..."
            curl -fsSL https://get.docker.com | sh
            usermod -aG docker root
          fi
          
          # Iniciar Docker
          systemctl start docker
          systemctl enable docker
          wait_for_service docker 20
          
          # Docker Compose
          if ! docker compose version >/dev/null 2>&1; then
            log "ğŸ“¦ Instalando Docker Compose..."
            apt-get install -y docker-compose-plugin
          fi
          log "âœ… Docker OK: $(docker --version)"
          
          # PM2
          if ! command -v pm2 >/dev/null 2>&1; then
            log "ğŸ“¦ Instalando PM2..."
            npm install -g pm2@latest
          fi
          log "âœ… PM2 OK: $(pm2 --version)"
          
          # Nginx
          if ! command -v nginx >/dev/null 2>&1; then
            log "ğŸ“¦ Instalando Nginx..."
            apt-get install -y nginx
          fi
          
          # ====================================
          # ETAPA 4: CONFIGURAR PROJETO
          # ====================================
          log "ğŸš€ ETAPA 4: Configurando projeto..."
          
          # Criar estrutura de diretÃ³rios
          mkdir -p panel/data
          mkdir -p docker/instances
          chmod 755 panel/data docker/instances
          
          # Arquivo de ambiente para backend
          cat > panel/backend/.env << EOF
NODE_ENV=production
PORT=5000
VPS_IP=$VPS_IP
DOCKER_PATH=$APP_DIR/docker
DATA_PATH=$APP_DIR/panel/data
EOF
          
          # ====================================
          # ETAPA 5: INSTALAR DEPENDÃŠNCIAS NODE
          # ====================================
          log "ğŸš€ ETAPA 5: Instalando dependÃªncias Node.js..."
          
          # Backend
          cd $APP_DIR/panel/backend
          log "ğŸ“¦ Backend dependencies..."
          npm ci --only=production --silent
          
          # Frontend
          cd $APP_DIR/panel/frontend
          log "ğŸ“¦ Frontend dependencies..."
          npm ci --silent
          
          # Build frontend
          log "ğŸ—ï¸ Building frontend..."
          npm run build
          
          # Verificar build
          if [ ! -d "dist" ] || [ ! -f "dist/index.html" ]; then
            log "âŒ Build do frontend falhou"
            exit 1
          fi
          log "âœ… Frontend buildado"
          
          # ====================================
          # ETAPA 6: CONFIGURAR NGINX
          # ====================================
          log "ğŸš€ ETAPA 6: Configurando Nginx..."
          
          # Remover config padrÃ£o
          rm -f /etc/nginx/sites-enabled/default
          
          # Nova configuraÃ§Ã£o
          cat > /etc/nginx/sites-available/supabase-panel << EOF
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name _;
    
    root $APP_DIR/panel/frontend/dist;
    index index.html;
    
    # Logs
    access_log /var/log/nginx/supabase-panel.access.log;
    error_log /var/log/nginx/supabase-panel.error.log;
    
    # Frontend - servir arquivos estÃ¡ticos
    location / {
        try_files \$uri \$uri/ /index.html;
        add_header Cache-Control "public, max-age=3600";
    }
    
    # API - proxy para backend
    location /api/ {
        proxy_pass http://127.0.0.1:5000/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;
        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
    }
    
    # Health check
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
EOF
          
          # Ativar site
          ln -sf /etc/nginx/sites-available/supabase-panel /etc/nginx/sites-enabled/
          
          # Testar configuraÃ§Ã£o
          if ! nginx -t; then
            log "âŒ ConfiguraÃ§Ã£o Nginx invÃ¡lida"
            cat /etc/nginx/sites-available/supabase-panel
            exit 1
          fi
          log "âœ… Nginx configurado"
          
          # ====================================
          # ETAPA 7: INICIAR SERVIÃ‡OS
          # ====================================
          log "ğŸš€ ETAPA 7: Iniciando serviÃ§os..."
          
          # Iniciar backend
          cd $APP_DIR/panel/backend
          log "ğŸš€ Iniciando backend..."
          
          # Matar processos PM2 antigos
          pm2 kill 2>/dev/null || true
          sleep 2
          
          # Iniciar novo processo
          NODE_ENV=production pm2 start server.js \
            --name "supabase-panel-backend" \
            --time \
            --log-date-format "YYYY-MM-DD HH:mm:ss Z" \
            --max-memory-restart 500M
          
          # Aguardar backend
          sleep 5
          
          # Verificar se backend estÃ¡ rodando
          if ! pm2 describe supabase-panel-backend | grep -q "online"; then
            log "âŒ Backend falhou ao iniciar"
            pm2 logs supabase-panel-backend --lines 20
            exit 1
          fi
          log "âœ… Backend iniciado"
          
          # Iniciar Nginx
          log "ğŸŒ Iniciando Nginx..."
          systemctl start nginx
          systemctl enable nginx
          wait_for_service nginx 15
          
          # ====================================
          # ETAPA 8: HEALTH CHECKS DETALHADOS
          # ====================================
          log "ğŸš€ ETAPA 8: Verificando serviÃ§os..."
          
          sleep 10  # Aguardar estabilizaÃ§Ã£o
          
          FAILED_SERVICES=""
          
          # 1. Verificar PM2
          log "ğŸ” Testando PM2..."
          if pm2 describe supabase-panel-backend | grep -q "online"; then
            log "âœ… PM2 Backend: ONLINE"
          else
            log "âŒ PM2 Backend: OFFLINE"
            FAILED_SERVICES="$FAILED_SERVICES backend"
            pm2 logs supabase-panel-backend --lines 10
          fi
          
          # 2. Verificar Nginx
          log "ğŸ” Testando Nginx..."
          if systemctl is-active --quiet nginx; then
            log "âœ… Nginx: ATIVO"
          else
            log "âŒ Nginx: INATIVO"
            FAILED_SERVICES="$FAILED_SERVICES nginx"
            systemctl status nginx --no-pager
          fi
          
          # 3. Verificar Docker
          log "ğŸ” Testando Docker..."
          if systemctl is-active --quiet docker; then
            log "âœ… Docker: ATIVO"
          else
            log "âŒ Docker: INATIVO"
            FAILED_SERVICES="$FAILED_SERVICES docker"
          fi
          
          # 4. Testar Frontend HTTP
          log "ğŸ” Testando Frontend..."
          for i in {1..5}; do
            if curl -f -s -m 5 http://localhost/ | grep -q "Supabase" 2>/dev/null; then
              log "âœ… Frontend: RESPONDENDO"
              break
            elif [ $i -eq 5 ]; then
              log "âŒ Frontend: NÃƒO RESPONDE"
              FAILED_SERVICES="$FAILED_SERVICES frontend"
              curl -v http://localhost/ || true
            else
              log "â³ Frontend tentativa $i/5..."
              sleep 3
            fi
          done
          
          # 5. Testar API Backend
          log "ğŸ” Testando API..."
          for i in {1..5}; do
            if curl -f -s -m 5 http://localhost:5000/api/info | grep -q "version" 2>/dev/null; then
              log "âœ… API Direta: RESPONDENDO"
              break
            elif [ $i -eq 5 ]; then
              log "âŒ API Direta: NÃƒO RESPONDE"
              FAILED_SERVICES="$FAILED_SERVICES api-direct"
            else
              log "â³ API tentativa $i/5..."
              sleep 3
            fi
          done
          
          # 6. Testar API via Nginx
          log "ğŸ” Testando API via Nginx..."
          for i in {1..5}; do
            if curl -f -s -m 5 http://localhost/api/info | grep -q "version" 2>/dev/null; then
              log "âœ… API via Nginx: RESPONDENDO"
              break
            elif [ $i -eq 5 ]; then
              log "âŒ API via Nginx: NÃƒO RESPONDE"
              FAILED_SERVICES="$FAILED_SERVICES api"
            else
              log "â³ API Nginx tentativa $i/5..."
              sleep 3
            fi
          done
          
          # ====================================
          # ETAPA 9: AUTO-START
          # ====================================
          log "ğŸš€ ETAPA 9: Configurando auto-start..."
          
          # PM2 startup
          pm2 save
          env PATH=$PATH:/usr/bin pm2 startup systemd -u root --hp /root --silent
          
          # ====================================
          # ETAPA 10: RESULTADO
          # ====================================
          log "ğŸ“Š Status final dos serviÃ§os:"
          echo "PM2: $(pm2 describe supabase-panel-backend | grep -o 'status.*' | head -1)"
          echo "Nginx: $(systemctl is-active nginx)"
          echo "Docker: $(systemctl is-active docker)"
          
          if [ -n "$FAILED_SERVICES" ]; then
            log "âŒ DEPLOY COM PROBLEMAS. ServiÃ§os com falha:$FAILED_SERVICES"
            log ""
            log "ğŸ”§ InformaÃ§Ãµes de debug:"
            log "PM2 Logs:"
            pm2 logs supabase-panel-backend --lines 15 || true
            log "Nginx Status:"
            systemctl status nginx --no-pager || true
            log "Nginx Logs:"
            tail -20 /var/log/nginx/error.log || true
            log "Portas em uso:"
            netstat -tlnp | grep ":80\|:5000" || true
            exit 1
          else
            log "ğŸ‰ DEPLOY CONCLUÃDO COM SUCESSO!"
            log ""
            log "ğŸŒ AplicaÃ§Ã£o disponÃ­vel:"
            log "   ğŸ“± Painel: http://$VPS_IP/"
            log "   ğŸ”§ API: http://$VPS_IP/api/info"
            log ""
            log "ğŸ“Š ServiÃ§os ativos:"
            pm2 list
            log ""
            log "ğŸ³ Docker pronto para instÃ¢ncias Supabase"
            log "ğŸ¯ Use o painel para criar e gerenciar instÃ¢ncias"
          fi